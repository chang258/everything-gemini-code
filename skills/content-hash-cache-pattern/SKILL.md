---
name: content-hash-cache-pattern
description: 使用 SHA-256 內容雜湊快取高成本的檔案處理結果。與路徑無關、內容變更自動失效，適用於 PDF 解析、圖片分析及文字提取等流水線。
---

# Content-Hash File Cache Pattern

此技能介紹了如何利用檔案內容的 SHA-256 雜湊值（而非檔案路徑）作為快取鍵 (Cache Key)。這種方法能確保檔案即使被移動或重新命名，快取依然有效；而一旦檔案內容發生任何變更，快取會自動失效。

## 觸發時機
- 建立檔案處理流水線（如 PDF 解析、圖片分析、OCR）時。
- 處理成本高昂且相同檔案會被重複處理時。
- 需要為現有的純函數 (Pure Functions) 增加快取層而不改動其內部邏輯時。
- 需要實作具備 `--cache / --no-cache` 選項的 CLI 工具時。

## 核心模式 (Core Pattern)

### 1. 基於內容的快取鍵
不要使用檔案路徑，而是計算檔案內容的 SHA-256。
- **優點**: 檔案移動/更名 = 快取命中 (Hit)；內容變更 = 自動失效。
- **實作**: 針對大型檔案，應採取分塊 (Chunked) 讀取以節省記憶體。

### 2. 獨立的快取儲存
將每個快取項目儲存為 `{hash}.json`。
- 這種結構支援 O(1) 的快速查找，且不需要維護額外的索引檔案。

### 3. 服務層包裝 (Service Layer Wrapper)
遵循單一職責原則 (SRP)，保持原始處理函數的純粹性，將快取邏輯放在獨立的包裝層。

```python
def extract_with_cache(file_path, cache_dir):
    # 1. 計算 Hash
    # 2. 檢查快取 (Read Cache)
    # 3. 若命中則回傳結果
    # 4. 若未命中則執行處理、寫入快取 (Write Cache) 並回傳
```

## 關鍵設計決策

| 決策 | 理由 |
| :--- | :--- |
| **SHA-256 雜湊** | 與路徑無關，內容變更即自動失效。 |
| **{hash}.json 命名** | 查找速度快，結構簡單。 |
| **服務層包裝** | 處理函數保持純粹，易於測試與維護。 |
| **損壞容錯** | 若 JSON 解析失敗，視為快取未命中並重新處理，不應崩潰。 |

## 最佳實踐
- **雜湊內容而非路徑**: 路徑會變，但內容識別碼不變。
- **分塊雜湊**: 處理大檔案時，避免將整個檔案載入記憶體。
- **紀錄命中狀態**: 在日誌中記錄快取命中/未命中，並附帶截斷的 Hash 值以便偵錯。

## 反模式
- **基於路徑的快取**: 當使用者移動檔案時，快取會失效。
- **在處理函數內嵌入快取邏輯**: 違反 SRP，讓核心邏輯變得難以複用。

---
*註：若資料必須保持即時性（如即時監控數據）或結果依賴於檔案內容以外的參數，則不應使用此快取模式。*
